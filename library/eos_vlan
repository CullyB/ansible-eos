#!/usr/bin/python
#
# Copyright (c) 2014, Arista Networks, Inc.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
#   Redistributions of source code must retain the above copyright notice,
#   this list of conditions and the following disclaimer.
#
#   Redistributions in binary form must reproduce the above copyright
#   notice, this list of conditions and the following disclaimer in the
#   documentation and/or other materials provided with the distribution.
#
#   Neither the name of Arista Networks nor the names of its
#   contributors may be used to endorse or promote products derived from
#   this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL ARISTA NETWORKS
# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
DOCUMENTATION = """
module: eos_vlan
short_description: Manage VLAN resources in EOS
description:
  - Provides active state management of VLAN configuration on Arista EOS
    nodes. All configuration of resources is idempotent unless
    otherwise specified.
author: Arista EOS+
notes:
requirements:
  - Arista EOS 4.12.0 or later
  - EOS command API enabled
  - pyeapi 0.1.0 or later
options:
  vlanid:
    description:
      - The unique VLAN identifier associated with this resource.  The value
        for this identiifer must be in the range of 1 to 4094.
    required: false
    aliases: []
  name:
    description:
      - An ASCII string identifer for this VLAN
    required: True
    default: null
    aliases: []
  enable:
    description:
      - Configures the administrative state for the vlan, true if the vlan
        should be enabled otherwise false
    required: false
    default: null
    choices: [true, false]
    aliases: []
  config:
    description:
      - Configures the path to the pyeapi config file
    required: false
    default: null
    aliases: []
  state:
    description:
      - The state of the VLAN related to the current running configuration
    required: false
    default: 'configured'
    choices: ['configured', 'unconfigured', 'default']
    aliases: []
  null_as_default:
    description:
      - Instructs the module how to handle null values.  If this flag is set
        then null values trigger default configuration otherwise do nothing
    required: false
    default: false
    choices: BOOLEANS
    aliases: []
"""
import syslog

from ansible.module_utils.basic import *

import pyeapi.client

from pyeapi.api.vlans import isvlan


def log(entry):
    syslog.openlog('ansible-eos')
    syslog.syslog(syslog.LOG_NOTICE, str(entry))

def get_instance(node, vlanid):
    result = node.api('vlans').getall()
    instance = dict(vlanid=vlanid, state='unconfigured')
    if vlanid in result:
        instance['state'] = 'configured'
        instance['name'] = result[vlanid]['name']
        instance['enable'] = result[vlanid]['state'] == 'active'
    return instance

def create_instance(node, vlanid):
    node.api('vlans').create(vlanid)
    return get_instance(node, vlanid)

def set_name(node, vlanid, name=None, default=False, **kwargs):
    log("Invoked set_name for vlanid %s with value %s and default "
        "%s" % (vlanid, name, default))
    api = node.api('vlans')
    if default:
        return api.set_name(vlanid, default=True)
    else:
        return api.set_name(vlanid, name)

def set_enable(node, vlanid, enable=None, default=False, **kwargs):
    log("Invoded set_enable for vlanid %s with value %s and default "
        "%s" % (vlanid, enable, default))
    api = node.api('vlans')
    if default:
        return api.set_state(vlanid, default=True)
    else:
        value = 'active' if enable else 'suspend'
        return api.set_state(vlanid, value)

def main():

    argument_spec = dict(
        vlanid=dict(required=True),
        enable=dict(type='bool', default=True),
        name=dict(),
        config=dict(default='/mnt/flash/eapi.conf'),
        connection=dict(default='localhost'),
        null_as_default=dict(type='bool', default=False),
        state=dict(default='configured',
                   choices=['configured', 'unconfigured'])
    )

    module = AnsibleModule(argument_spec=argument_spec,
                           supports_check_mode=True)

    pyeapi.client.load_config(module.params['config'])
    node = pyeapi.client.connect_to(module.params['connection'])
    node.api('vlans').autorefresh = True

    result = dict(changed=False, created=False, removed=False, changes=dict())
    state = module.params['state']
    null_as_default = module.params['null_as_default']

    vlanid = module.params['vlanid']
    if not isvlan(vlanid):
        module.fail_json(msg='vlanid is not a valid value')

    attributes = {
        'vlanid': vlanid,
        'name': module.params['name'],
        'enable': module.params['enable']
    }

    instance = get_instance(node, vlanid)

    if state == 'configured':
        if instance['state'] == 'unconfigured':
            if not module.check_mode:
                instance = create_instance(node, vlanid)
            result['created'] = True

        changeset = attributes.viewitems() - instance.viewitems()
        for key, value in changeset:
            func = 'set_%s' % key
            if func in globals():
                command = globals().get(func)
                default = value is None and null_as_default
                if value is not None or default:
                    result['changes'][key] = value
                    result['changed'] = True
                    if not module.check_mode:
                        command(node, **attributes)

    elif instance['state'] == 'configured' and state == 'unconfigured':
        result['removed'] = True
        if not module.check_mode:
            node.api('vlans').delete(vlanid)

    result['instance'] = get_instance(node, vlanid)
    module.exit_json(**result)


main()
